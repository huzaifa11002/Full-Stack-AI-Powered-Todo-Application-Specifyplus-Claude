# Data Model

**Feature**: Next.js Authenticated Todo Frontend
**Branch**: `002-nextjs-auth-frontend`
**Date**: 2026-01-10

## Overview

This document defines the data entities used in the Next.js frontend application. These entities represent the client-side data structures that interact with the FastAPI backend via REST API.

---

## Entity 1: User

**Description**: Represents an authenticated user in the system.

**Source**: Returned from Better Auth authentication endpoints and stored in AuthContext.

### Fields

| Field | Type | Required | Constraints | Description |
|-------|------|----------|-------------|-------------|
| `id` | string | Yes | UUID format | Unique identifier for the user |
| `email` | string | Yes | Valid email format | User's email address (used for login) |
| `username` | string | No | Max 50 characters | Optional display name |

### Validation Rules

- **email**: Must be valid email format (validated by Better Auth)
- **id**: Generated by backend, immutable
- **username**: Optional, if provided must be 1-50 characters

### State Transitions

N/A - User entity is read-only on the frontend (created/updated via Better Auth)

### Relationships

- **One-to-Many with Task**: One user owns many tasks
- **One-to-One with AuthSession**: One user has one active session

### Example

```typescript
{
  id: "550e8400-e29b-41d4-a716-446655440000",
  email: "user@example.com",
  username: "John Doe"
}
```

---

## Entity 2: Task

**Description**: Represents a todo item belonging to a user.

**Source**: Fetched from and persisted to the FastAPI backend via REST API.

### Fields

| Field | Type | Required | Constraints | Description |
|-------|------|----------|-------------|-------------|
| `id` | string | Yes | UUID format | Unique identifier for the task |
| `user_id` | string | Yes | UUID format | ID of the user who owns this task |
| `title` | string | Yes | 1-200 characters | Task title/summary |
| `description` | string \| null | No | Max 2000 characters | Detailed task description |
| `is_completed` | boolean | Yes | true or false | Completion status |
| `created_at` | string | Yes | ISO 8601 datetime | Timestamp when task was created |
| `updated_at` | string | Yes | ISO 8601 datetime | Timestamp when task was last updated |

### Validation Rules

- **title**:
  - Required, cannot be empty or whitespace-only
  - Must be 1-200 characters
  - Validated on client before API submission
- **description**:
  - Optional, can be null or empty string
  - If provided, max 2000 characters
- **is_completed**:
  - Boolean, defaults to false on creation
- **id, user_id, created_at, updated_at**:
  - Generated by backend, read-only on frontend

### State Transitions

```
[New Task] --create--> [Incomplete Task]
[Incomplete Task] --toggle--> [Completed Task]
[Completed Task] --toggle--> [Incomplete Task]
[Incomplete Task] --update--> [Incomplete Task]
[Completed Task] --update--> [Completed Task]
[Any State] --delete--> [Deleted]
```

### Relationships

- **Many-to-One with User**: Many tasks belong to one user
- **User Isolation**: Tasks are scoped to user_id, enforced by API

### Example

```typescript
{
  id: "7c9e6679-7425-40de-944b-e07fc1f90ae7",
  user_id: "550e8400-e29b-41d4-a716-446655440000",
  title: "Complete project documentation",
  description: "Write comprehensive docs for the API endpoints",
  is_completed: false,
  created_at: "2026-01-10T10:30:00Z",
  updated_at: "2026-01-10T10:30:00Z"
}
```

---

## Entity 3: AuthSession

**Description**: Represents the current authentication session state in the frontend.

**Source**: Managed by AuthContext, combines Better Auth session with JWT token.

### Fields

| Field | Type | Required | Constraints | Description |
|-------|------|----------|-------------|-------------|
| `user` | User \| null | Yes | User object or null | Currently authenticated user |
| `token` | string \| null | Yes | JWT format | JWT access token |
| `isAuthenticated` | boolean | Yes | true or false | Whether user is authenticated |
| `isLoading` | boolean | Yes | true or false | Whether auth state is being loaded |

### Validation Rules

- **user**: Must be valid User object when authenticated, null otherwise
- **token**: Must be valid JWT string when authenticated, null otherwise
- **isAuthenticated**: Derived from presence of user and token
- **isLoading**: True during initial load and auth operations

### State Transitions

```
[Initial] --load--> [Loading] --success--> [Authenticated]
[Initial] --load--> [Loading] --failure--> [Unauthenticated]
[Authenticated] --logout--> [Unauthenticated]
[Unauthenticated] --login--> [Loading] --success--> [Authenticated]
[Unauthenticated] --signup--> [Loading] --success--> [Authenticated]
[Authenticated] --token-expired--> [Unauthenticated]
```

### Relationships

- **One-to-One with User**: One session corresponds to one user
- **Stored in**: React Context (AuthContext)
- **Persisted in**: localStorage (token only)

### Example

```typescript
// Authenticated state
{
  user: {
    id: "550e8400-e29b-41d4-a716-446655440000",
    email: "user@example.com",
    username: "John Doe"
  },
  token: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  isAuthenticated: true,
  isLoading: false
}

// Unauthenticated state
{
  user: null,
  token: null,
  isAuthenticated: false,
  isLoading: false
}

// Loading state
{
  user: null,
  token: null,
  isAuthenticated: false,
  isLoading: true
}
```

---

## Data Transfer Objects (DTOs)

### TaskCreate

**Purpose**: Data structure for creating a new task.

**Fields**:
- `title` (string, required): Task title (1-200 chars)
- `description` (string, optional): Task description (max 2000 chars)

**Example**:
```typescript
{
  title: "Buy groceries",
  description: "Milk, eggs, bread"
}
```

### TaskUpdate

**Purpose**: Data structure for updating an existing task.

**Fields**:
- `title` (string, optional): Updated task title (1-200 chars)
- `description` (string, optional): Updated task description (max 2000 chars)
- `is_completed` (boolean, optional): Updated completion status

**Example**:
```typescript
{
  title: "Buy groceries and snacks",
  is_completed: true
}
```

### LoginCredentials

**Purpose**: Data structure for user login.

**Fields**:
- `email` (string, required): User's email address
- `password` (string, required): User's password (min 8 chars)

**Example**:
```typescript
{
  email: "user@example.com",
  password: "SecurePass123"
}
```

### SignupData

**Purpose**: Data structure for user registration.

**Fields**:
- `email` (string, required): User's email address
- `password` (string, required): User's password (min 8 chars)
- `confirmPassword` (string, required): Password confirmation (must match password)

**Example**:
```typescript
{
  email: "newuser@example.com",
  password: "SecurePass123",
  confirmPassword: "SecurePass123"
}
```

---

## API Response Structures

### ApiError

**Purpose**: Standard error response from API.

**Fields**:
- `detail` (string): Human-readable error message
- `status_code` (number): HTTP status code

**Example**:
```typescript
{
  detail: "Task not found",
  status_code: 404
}
```

### ApiResponse<T>

**Purpose**: Generic wrapper for API responses.

**Fields**:
- `data` (T): Response data of type T
- `error` (ApiError, optional): Error object if request failed

**Example**:
```typescript
// Success response
{
  data: {
    id: "7c9e6679-7425-40de-944b-e07fc1f90ae7",
    title: "Complete documentation",
    // ... other task fields
  }
}

// Error response
{
  error: {
    detail: "Validation error: title is required",
    status_code: 422
  }
}
```

---

## Data Flow Diagrams

### Authentication Flow

```
User Input (email, password)
  ↓
LoginForm validation
  ↓
Better Auth signIn()
  ↓
JWT Token received
  ↓
Store in localStorage
  ↓
Update AuthContext
  ↓
Redirect to Dashboard
```

### Task Creation Flow

```
User Input (title, description)
  ↓
TaskForm validation
  ↓
Optimistic Update (add to local state)
  ↓
API POST /api/{user_id}/tasks
  ↓
Success: Keep optimistic update
  ↓
Failure: Rollback + show error
```

### Task Toggle Flow

```
User clicks checkbox
  ↓
Optimistic Update (toggle is_completed)
  ↓
API PATCH /api/{user_id}/tasks/{task_id}/complete
  ↓
Success: Keep optimistic update
  ↓
Failure: Rollback + show error
```

---

## Storage Locations

| Entity | Storage Location | Persistence | Access Pattern |
|--------|-----------------|-------------|----------------|
| User | AuthContext (memory) | Session only | Via useAuth() hook |
| Token | localStorage | Persistent | Via useAuth() hook |
| Task[] | Component state (useTasks) | Session only | Via useTasks() hook |
| AuthSession | AuthContext (memory) | Session only | Via useAuth() hook |

---

## Data Validation Summary

### Client-Side Validation

| Field | Validation Rules | Error Messages |
|-------|-----------------|----------------|
| email | Valid email format | "Please enter a valid email address" |
| password | Min 8 characters, contains letter + number | "Password must be at least 8 characters with a letter and number" |
| confirmPassword | Matches password | "Passwords do not match" |
| task.title | Required, 1-200 chars, not whitespace-only | "Title is required" / "Title must be under 200 characters" |
| task.description | Max 2000 chars if provided | "Description must be under 2000 characters" |

### Server-Side Validation

All validation is also performed on the backend (FastAPI with Pydantic). Client-side validation provides immediate feedback, server-side validation ensures data integrity.

---

## Indexing & Performance Considerations

**Frontend Considerations**:
- Tasks stored in array, sorted by completion status
- No indexing needed (small dataset, <1000 tasks expected)
- Optimistic updates for instant UI feedback
- React.memo on TaskItem to prevent unnecessary re-renders

**Backend Considerations** (from backend spec):
- Database indexes on user_id for efficient task queries
- Pagination not implemented (out of scope)

---

## Security Considerations

1. **User Isolation**:
   - All task operations include user_id in API path
   - Backend enforces user_id matches JWT token
   - Frontend never displays tasks from other users

2. **Token Security**:
   - JWT stored in localStorage (acknowledged XSS risk)
   - Token never exposed in URLs or logs
   - Token cleared on logout

3. **Input Sanitization**:
   - All user input validated before submission
   - No HTML rendering of user content (XSS prevention)
   - API handles additional sanitization

---

**Phase 1 Data Model Complete**: All entities, DTOs, and data flows documented. Ready to generate TypeScript type definitions in contracts/.
